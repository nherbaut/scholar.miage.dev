<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">

    <meta charset="UTF-8">
    <title>MIAGE Scholar</title>
    <script src="https://cdn.socket.io/socket.io-3.0.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script>

    <script>


        var bag_of_doi = "";
        var item_info = new Array();

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:application/x-bibtex;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

        function onLoaded(evt) {
            if (document.getElementById("querybox").value == "") {
                document.getElementById("querybox").value = window.localStorage.getItem("query");
            } else {
                //we already have a query, just fetch the results
                handle_submit();
            }
        }


        function textAreaChange() {
            updateQueryStorage(document.getElementById("querybox").value);
        }

        function updateQueryStorage(str) {
            window.localStorage.setItem("query", str);
        }


        window.onload = onLoaded;

        const socket = io();

        socket.on('connect', function () {
            socket.emit('my event', {data: 'I\'m connected!'});
        });

        socket.on('count', (count) => {
            document.getElementById("main_button").value = "fetch " + count + " results ";
            handle_submit = sendDoisRequest;
            document.getElementById("permalink").removeAttribute("hidden");
        });

        socket.on('dois', (data) => {
            console.log(data);

        });

        socket.on('feed_generated', (data) => {
            window.open("/feed/" + data["feed_id"] + ".rss", '_blank');

        });

        socket.on('permalink_generated', (data) => {

            document.getElementById("permalink").value = "Copied!";
            navigator.clipboard.writeText(data);


        });


        socket.on('doi_export_done', (data) => {
            document.getElementById("dlresults").removeAttribute("hidden");
            document.getElementById("rss").removeAttribute("hidden");


        })

        socket.on('doi_update', (data) => {

            document.getElementById("pb_success").setAttribute("max", data["total"]);
            document.getElementById("pb_success").setAttribute("value", data["done"]);
            document.getElementById("pb_success_count").innerHTML = data["done"] + "/" + data["total"];
            document.getElementById("pb_failure").setAttribute("max", data["total"]);
            document.getElementById("pb_failure").setAttribute("value", data["failed"]);
            document.getElementById("pb_failure_count").innerHTML = data["failed"] + "/" + data["total"];


        });

        socket.on('doi_results', (data) => {
            for (let doi_item of data) {
                var doi = doi_item["doi"];
                var title = doi_item["title"];
                var year = doi_item["year"]
                add_item_to_table(doi_item);
                if (doi != "") {
                    item_info.push(doi_item);

                    bag_of_doi += "@article{article1, \n\tdoi = { " + doi + "}\n },\n"
                }
            }


        });

        function add_item_to_table(doi_item) {
            var row = document.getElementById("doi_table").insertRow()

            if (doi_item["doi"] != "") {
                row.classList.add("table-success");
                //sometime doi contain _ for books chapter, remove it since it does always work with sci-hub
                full_doi = doi_item["doi"].split("_")[0]
                row.innerHTML = "<th  scope=\"row\"><a href=\"https://www.doi.org/" + doi_item["doi"] + "\">" + doi_item["doi"] + "</a></th><td>" + doi_item["year"] + "</td><td>" + doi_item["title"] + "</td>" + "<td>" + doi_item["pubtitle"] + "</td>"
                row.innerHTML += "<td><a href=\"/sameauthor?name=" + encodeURIComponent(doi_item["X-FirstAuthor"]) + "\" target=\"_blank\"\">" + doi_item["X-FirstAuthor"] + "</td>"
                row.innerHTML += "<td><a href=\"https://sci-hub.se/" + full_doi + "\" target=\"_blank\">Download</a></td>"
                row.innerHTML += "<td><a href=\"/snowball?title=" + encodeURIComponent(doi_item["title"]) + "\" target=\"_blank\"\">Snowball</td>"
            } else {
                row.classList.add("table-dark");
                row.innerHTML = "<th  scope=\"row\">None</th><td>" + doi_item["year"] + "</td><td>" + doi_item["title"] + "</td>" + "<td>" + doi_item["pubtitle"] + "</td><td></td>" + "<td>-</td><td>-</td>";
            }


        }


        function sendCountRequest() {
            document.getElementById("querybox").disabled = true;
            socket.emit('count', {query: document.getElementById("querybox").value});
        }

        function sendDoisRequest() {

            document.getElementById("main_button").disabled = true;
            socket.emit('get_dois', {query: document.getElementById("querybox").value});

        }


        handle_submit = sendCountRequest;

        function resetAll() {
            bag_of_doi = "";
            handle_submit = sendCountRequest;
            document.getElementById("main_button").value = "Count Results";
            document.getElementById("dlresults").setAttribute("hidden", "true");
            document.getElementById("rss").setAttribute("hidden", "true");
            resetPermalinkButton();

            //document.getElementById("querybox").value = "";
            document.getElementById("pb_success").setAttribute("max", 0);
            document.getElementById("pb_success").setAttribute("value", 0);
            document.getElementById("pb_failure").setAttribute("max", 0);
            document.getElementById("pb_failure").setAttribute("value", 0);
            document.getElementById("pb_failure_count").innerHTML = "";
            document.getElementById("pb_success_count").innerHTML = "";
            document.getElementById("doi_table").innerHTML = "";
            document.getElementById("main_button").disabled = false;
            document.getElementById("querybox").disabled = false;
        }

        function downloadResults() {
            download("results.bib", bag_of_doi)
        }

        function copyPermalink() {

            socket.emit('create_permalink', {query: document.getElementById("querybox").value});


        }

        function createRssLink() {
            socket.emit('create_feed', {query: document.getElementById("querybox").value});
        }

        function resetPermalinkButton() {
            document.getElementById("permalink").value = "Get Query Permalink";
            document.getElementById("permalink").setAttribute("hidden", "true");
        }

    </script>
</head>
<body>
<div class="jumbotron">
    <h1 class="display-4">MIAGE Scholar</h1>
    <p class="lead">Export Scholar data for your SMS/SLRs</p>


    <p>

        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#import_procedure"
                aria-expanded="false" aria-controls="collapseExample">
            SMS/SLR Import Procedure
        </button>
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#importTuto"
                aria-expanded="false" aria-controls="collapseExample">
            SMS/SLR Import Tutorial (video)
        </button>
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#releaseNotes"
                aria-expanded="false" aria-controls="collapseExample">
            Release Notes
        </button>
        <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#sources"
                aria-expanded="false" aria-controls="collapseExample">
            Get the sources
        </button>
    </p>
    <div class="collapse" id="import_procedure">
        <div class="card card-body">
            <ol>
                <li>Type your query by following the <a
                        href="http://schema.elsevier.com/dtds/document/bkapi/search/SCOPUSSearchTips.htm">doc</a> e.g.
                    <i>TITLE-ABS-KEY(blockchain)
                        AND TITLE-ABS-KEY(INDUSTRY 4.0) AND (TITLE-ABS-KEY(Security) OR TITLE-ABS-KEY(Privacy))</i></li>
                <li>Click "count results" to get the number of results</li>
                <li>Once you have a number, click Fetch to resolve DOIs</li>
                <li>Once the resolving is done, a button allows you to download a bibtex file</li>
                <li>import it in <a href="https://www.mendeley.com/download-mendeley-desktop-legacy">mendeley Desktop Legacy</a></li>
                <li>Select all the (yet untitled) entries and right click > update details</li>
                <li>Wait for mendeley to populate each entry</li>
                <li>In mendeley, select all entires and export as a bib file</li>
                <li>Import your results in <a href="https://parsif.al/">parsif.al</a></li>
            </ol>
        </div>
    </div>

    <div class="collapse" id="importTuto">
        <div class="card card-body">
            <iframe src="https://mediatheque.univ-paris1.fr/video/2870-miage-scholar-tutorial-importing-search-results-in-parsifal/?is_iframe=true"
                    width="640" height="360" style="padding: 0; margin: 0; border:0" allowfullscreen></iframe>
        </div>
    </div>

    <div class="collapse" id="releaseNotes">
        <div class="card card-body">

            <h2>Release note</h2>
            <ul>
                <li>1.0.3 Added Permalink Support</li>
                <li>1.0.2 Added <a href="/feeds">RSS Support</a></li>
                <li>1.0.1 Added <a href="/history">History</a></li>
                <li>1.0.0 Initial version</li>
            </ul>
        </div>
    </div>

    <div class="collapse" id="sources">
        <div class="card card-body">
            <h2>Sources</h2>
            <a href="https://github.com/nherbaut/scpus-hack/">GitHub Repository</a>

<<<<<<< HEAD
        </div>
    </div>
=======
{% if  login_url %}
<input type="button" class="btn btn-primary" onclick="window.location='{{ login_url }}'" value="Connect to Mendeley" />
{% else %}
<input type="button" class="btn btn-error" onclick="window.location='{{ "/mendeleyLogout" }}'" value="Disconnect from Mendeley" />
{% endif %}

>>>>>>> mendeley_integration


</div>
<div style="width: 90%; margin: auto;">

    <form action="query" method="POST">
        <p>Query:</p>
        <p>example: TITLE-ABS-KEY(blockchain) AND TITLE-ABS-KEY(INDUSTRY 4.0) AND (TITLE-ABS-KEY(Security) OR
            TITLE-ABS-KEY(Privacy)) AND PUBYEAR > 2020</p>
        <fieldset>


            {% if count %}
                <textarea id="querybox" name="query" readonly>{{ query }}</textarea>


                </fieldset>
                <input class="btn btn-secondary" type="button" value="Reset" onclick="resetAll()"/>
                <input type="submit" value="Fetch {{ count }} results (up to 1000)">
            {% else %}
                <textarea id="querybox" name="query" onkeyup="textAreaChange()"
                          style="width:100%">{{ query }}</textarea>


                </fieldset>
                <input class="btn btn-secondary" type="button" value="Reset" onclick="resetAll()"/>
                <input class="btn btn-primary" id="main_button" type="button" value="Count Results"
                       onclick="handle_submit()">
            {% endif %}

        <input class="btn btn-success" id="dlresults" type="button" value="Download dois as bibtex"
               onclick="downloadResults()"
               hidden/>
        <input class="btn btn-success" id="rss" type="button" value="Create RSS Link"
               onclick="createRssLink()"
               hidden/>
        <input class="btn btn-success" id="permalink" type="button" value="Get Query Permalink"
               onclick="copyPermalink()"

               hidden/>

    </form>


    <div>
        <div>
            <label for="file">Resolved DOIs:</label>
            <progress id="pb_success" max="0" value="0"></progress>
            <span id="pb_success_count"></span>
        </div>
        <div>
            <label for="file">Entry without DOIs:</label>
            <progress id="pb_failure" max="0" value="0"></progress>
            <span id="pb_failure_count"></span>
        </div>
    </div>

    <table class="table table-bordered table-hover">
        <thead>
        <td>DOI</td>
        <td>Date</td>
        <td>Title</td>
        <td>Publication Title</td>
        <td>Author</td>
        <td>Sci-Hb link</td>
        <td>Snowball Link</td>

        </thead>
        <tbody id="doi_table">


        </tbody>

    </table>
</div>
</body>


</html>
